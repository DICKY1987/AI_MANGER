Pseudocode — Centralized CLI Stack + Config/Cache Guards (v0.2)
GOALS
  G1  One global install per ecosystem (Python, Node) — zero per-project duplicates
  G2  Centralize config/cache/data → stable, predictable locations
  G3  Guardrail against new duplicate folders in repos (self-healing)
  G4  Determinism via version pinning; controlled updates with reporting
  G5  Secrets managed securely; easy env export when needed
  G6  Continuous health checks + JSON reports for CI/ops visibility
  G7  Auditing & optional real-time alerts for file activity outside allow-list

ASSUMPTIONS
  OS = Windows 10/11; Shell = PowerShell 7+
  User-scope environment variables persist
  Optional: Windows Developer Mode (for symlinks) else use junctions
  Orchestrator = InvokeBuild (plugins register tasks)

CONFIG (single source of truth; JSON keys)
  ToolsRoot, PipxApps[], NpmGlobal[], CopilotPkgs[]
  Pins: { pipx: {name: ver}, npm: {name: ver} }
  MasterBin: { Enable, Path, Sources[], Priority[], DenyList[] }
  WatchRoots[], CentralCache, Scan: { Roots[], AllowCentral[], Patterns[], MinSizeKBForHash }
  Secrets: { VaultPath, EnvMap { ENV_VAR: secret_name } }
  Reports: { Dir }
  Audit: { AllowRoots[], Notify { Toast, WriteJson, WebhookUrl }, TaskName }

Constants (recommended defaults)
TOOLS_ROOT      := "C:\Tools"
PIPX_HOME       := TOOLS_ROOT + "\pipx\home"
PIPX_BIN        := TOOLS_ROOT + "\pipx\bin"
PY_DEFAULT      := "py -3.12"

NODE_PREFIX     := TOOLS_ROOT + "\node"
NPM_BIN         := TOOLS_ROOT + "\node\npm"
PNPM_HOME       := TOOLS_ROOT + "\pnpm\bin"
PNPM_STORE      := TOOLS_ROOT + "\pnpm\store"

XDG_CONFIG_HOME := TOOLS_ROOT + "\config"
XDG_CACHE_HOME  := TOOLS_ROOT + "\cache"
XDG_DATA_HOME   := TOOLS_ROOT + "\data"

CARGO_HOME      := TOOLS_ROOT + "\cargo"
RUSTUP_HOME     := TOOLS_ROOT + "\rustup"
GOPATH          := TOOLS_ROOT + "\go"

MASTER_BIN      := TOOLS_ROOT + "\bin"          // optional single PATH entry

WATCH_ROOTS     := ["C:\Users\<YOU>\Projects", "D:\Work"]
QUARANTINE_DIR  := TOOLS_ROOT + "\quarantine"

CACHE_PATTERNS  := [ ".ruff_cache",".mypy_cache",".pytest_cache",
                     ".eslintcache",".prettier-cache","__pycache__",
                     ".cache","node_modules\.cache" ]
REPORTS_DIR     := "%LOCALAPPDATA%\CLI_Reports"

Phase A — Environment & PATH (idempotent)
FUNCTION SET_USER_ENV(name, value):
  set user env var name=value; set current-process env var name=value

FUNCTION PREPEND_USER_PATH(dir):
  dedupe dir in User PATH; ensure dir is FIRST; refresh current PATH

PROCEDURE CONFIGURE_ENV_BASELINES():
  // Python
  SET_USER_ENV("PIPX_HOME", PIPX_HOME)
  SET_USER_ENV("PIPX_BIN_DIR", PIPX_BIN)
  SET_USER_ENV("PIPX_DEFAULT_PYTHON", PY_DEFAULT)

  // Node
  RUN: npm config set prefix NODE_PREFIX --global
  SET_USER_ENV("PNPM_HOME", PNPM_HOME)
  RUN: pnpm config set store-dir PNPM_STORE

  // XDG centralization
  SET_USER_ENV("XDG_CONFIG_HOME", XDG_CONFIG_HOME)
  SET_USER_ENV("XDG_CACHE_HOME",  XDG_CACHE_HOME)
  SET_USER_ENV("XDG_DATA_HOME",   XDG_DATA_HOME)

  // Tool caches
  SET_USER_ENV("PIP_CACHE_DIR",   XDG_CACHE_HOME + "\pip")
  SET_USER_ENV("RUFF_CACHE_DIR",  XDG_CACHE_HOME + "\ruff")
  SET_USER_ENV("BLACK_CACHE_DIR", XDG_CACHE_HOME + "\black")
  SET_USER_ENV("MYPY_CACHE_DIR",  XDG_CACHE_HOME + "\mypy")
  SET_USER_ENV("UV_CACHE_DIR",    XDG_CACHE_HOME + "\uv")
  // optional: keep .pyc out of repos
  SET_USER_ENV("PYTHONPYCACHEPREFIX", XDG_CACHE_HOME + "\pyc")
  // ESLint cache if used
  SET_USER_ENV("ESLINT_CACHE", "true")
  SET_USER_ENV("ESLINT_CACHE_LOCATION", XDG_CACHE_HOME + "\eslint")

  // (Optional) Go/Rust
  SET_USER_ENV("CARGO_HOME",  CARGO_HOME)
  SET_USER_ENV("RUSTUP_HOME", RUSTUP_HOME)
  SET_USER_ENV("GOPATH",      GOPATH)

  // PATH order
  PREPEND_USER_PATH(PIPX_BIN)
  PREPEND_USER_PATH(PNPM_HOME)
  PREPEND_USER_PATH(NPM_BIN)
  PREPEND_USER_PATH(GOPATH + "\bin")
  PREPEND_USER_PATH(CARGO_HOME + "\bin")
  // optional: PREPEND_USER_PATH(MASTER_BIN)  // if MasterBin wrappers enabled

Phase B — Runtimes & Managers (install/repair)
PROCEDURE INSTALL_BASE_RUNTIMES():
  RUN (best-effort): winget install/upgrade Git.Git, OpenJS.NodeJS, Python.Python.3.12, GitHub.CLI, Microsoft.PowerShell

PROCEDURE ENSURE_PIPX_AND_PNPM():
  RUN: py -3 -m pip install --user --upgrade pip pipx
  RUN: pipx ensurepath
  RUN: npm install -g pnpm

PROCEDURE INSTALL_PYTHON_CLIS_VIA_PIPX():
  for name in Config.PipxApps:
    RUN: pipx install name --force

PROCEDURE INSTALL_NODE_CLIS_GLOBALLY():
  for name in Config.NpmGlobal: RUN: npm install -g name
  TRY install Copilot from Config.CopilotPkgs in order until success

Phase B2 — Version Pinning (determinism)
FUNCTION CURRENT_PIPX_VERSION(name): return version from "pipx runpip name show name"
FUNCTION CURRENT_NPM_VERSION(name):  return version from "npm ls -g name --depth=0 --json"
FUNCTION LATEST_PYPI_VERSION(name):  parse "py -m pip index versions name" (newest first)
FUNCTION LATEST_NPM_VERSION(name):   "npm view name version"

TASK Pin.Report:
  for each (name,ver) in Pins.pipx:  print want=ver, have=CURRENT_PIPX_VERSION(name)
  for each (name,ver) in Pins.npm:   print want=ver, have=CURRENT_NPM_VERSION(name)

TASK Pin.Sync:
  for (name,ver) in Pins.pipx: RUN: pipx install name==ver --force
  for (name,ver) in Pins.npm:  RUN: npm  install -g name@ver

Phase B3 — Updates (controlled drift + report)
TASK Update.Check:
  REPORT := { time, npm:[], pipx:[] }
  for name in Config.NpmGlobal:
    have := CURRENT_NPM_VERSION(name); latest := LATEST_NPM_VERSION(name)
    REPORT.npm.append({name, installed:have, latest, update:(have≠latest)})
  for name in Config.PipxApps:
    have := CURRENT_PIPX_VERSION(name); latest := LATEST_PYPI_VERSION(name)
    REPORT.pipx.append({name, installed:have, latest, update:(have≠latest)})
  WRITE REPORT → REPORTS_DIR\updates.json

TASK Update.All:
  RUN: for name in Config.NpmGlobal → npm update -g name
  RUN: pipx upgrade --all --include-injected

Phase C — Centralize Config/Cache (+ optional MasterBin)
PROCEDURE APPLY_CENTRALIZATION_ENVS():
  call CONFIGURE_ENV_BASELINES()

TASK MasterBin.Rebuild (if MasterBin.Enable):
  CLEAN MASTER_BIN\*.cmd
  for shim_dir in MasterBin.Sources (respect Priority order):
    for each *.cmd in shim_dir:
      if name ∈ MasterBin.DenyList → skip
      if name already wrapped by higher-priority source → skip
      write MASTER_BIN\name.cmd:
        preamble: set XDG_* + cache envs
        exec real shim with %*
        exit /b %errorlevel%
TASK MasterBin.Clean:
  delete MASTER_BIN\*.cmd

Phase D — Guards (enforce once + real-time) and Scanner
FUNCTION IS_LINK(path) := FileAttributes includes REPARSE_POINT

FUNCTION PROJECT_KEY(project_root) := MD5(lowercase(project_root))

FUNCTION CENTRAL_TARGET(project_root, dir_name):
  return XDG_CACHE_HOME + "\" + PROJECT_KEY(project_root) + "\" + dir_name

PROCEDURE REPLACE_WITH_LINK(project_dir, central_dir):
  ensure exists(central_dir)
  if exists(project_dir) and not IS_LINK(project_dir):
    move project_dir → QUARANTINE_DIR\name_timestamp
  ensure parent(project_dir)
  try mklink /D project_dir central_dir
    else try mklink /J project_dir central_dir
    else copy central_dir → project_dir   // last resort, warn

TASK Enforce.Once:
  for root in WATCH_ROOTS:
    for each directory d under root:
      if NAME(d) ∈ CACHE_PATTERNS and not IS_LINK(d):
        proj := nearest git root of d or root
        REPLACE_WITH_LINK(d, CENTRAL_TARGET(proj, NAME(d)))

TASK Watcher.Watch:
  watch roots for Created/Renamed directories; on event:
    if NAME ∈ CACHE_PATTERNS and not IS_LINK:
      proj := nearest git root or watched root
      REPLACE_WITH_LINK(d, CENTRAL_TARGET(proj, NAME))

// Scanner: passive checks + JSON reports

TASK Scan.Misplaced:
  findings := []
  for root in Scan.Roots:
    walk directories:
      if under Scan.AllowCentral → continue
      if NAME or path matches Scan.Patterns:
        proj := nearest git root or root
        findings.append({path, name, project:proj})
  WRITE {time, misplaced: findings} → REPORTS_DIR\misplaced.json

TASK Scan.Duplicates:
  by_hash := map<SHA256, list<path>>
  for files under Scan.Roots (size ≥ MinSizeKBForHash):
    h := hash(file)
    by_hash[h].append(path)
  dups := [{hash, count, files} where count > 1]
  WRITE {time, duplicates: dups} → REPORTS_DIR\duplicates.json

TASK Scan.Report := depends(Scan.Misplaced, Scan.Duplicates)

Phase E — Secrets Vault (DPAPI, user-scoped)
VAULT_PATH := expand(Secrets.VaultPath)

FUNCTION PROTECT(s): DPAPI Protect(CurrentUser) → base64
FUNCTION UNPROTECT(b64): DPAPI Unprotect(CurrentUser) → string

TASK Secrets.Set:
  Name := prompt; Value := secure prompt
  Vault[Name] := PROTECT(Value); save VAULT_PATH

TASK Secrets.List:
  print sorted keys of Vault

TASK Secrets.Get(Name):
  val := UNPROTECT(Vault[Name]); copy to clipboard (do NOT echo)

TASK Secrets.ExportEnv:
  for (ENV_VAR, secret_name) in Secrets.EnvMap:
    if Vault has secret_name:
      set process env ENV_VAR := UNPROTECT(Vault[secret_name])

Phase F — Health Check (JSON)
FUNCTION CHECK_CMD(name): return {cmd:name, path:=where name, ok:=bool(path)}
FUNCTION CHECK_DIR(path): return {path, exists:Test-Path(path)}
FUNCTION PATH_ORDER_OK(wantOrder[]): 
  u := User PATH split ';'; indices := [indexOf(w) in u]
  exists := all indices≥0; ordered := exists AND indices strictly ascending
  return {exists, ordered, indices, userPath:u.join(';')}

TASK Health.Check:
  wantOrder := [PIPX_BIN, PNPM_HOME, NPM_BIN, GOPATH\bin, CARGO_HOME\bin]
  res := {
    time, 
    env:{selected key envs + npm prefix},
    dirs:[CHECK_DIR for key dirs],
    pathOrder := PATH_ORDER_OK(wantOrder),
    commands:[CHECK_CMD for core CLIs],
    advice:[]
  }
  if not res.pathOrder.exists or not res.pathOrder.ordered:
    advice += "Reorder User PATH to front-load desired bins"
  for each missing dir/command:
    advice += "Create/Install: <item>"
  WRITE res → REPORTS_DIR\health.json

Phase G — Auditing & Alerts (Event 4663)
PROCEDURE ENABLE_OBJECT_ACCESS_AUDIT():
  Local Security Policy → Audit Object Access: Success+Failure

PROCEDURE ENABLE_FOLDER_AUDIT(path):
  Folder → Advanced → Auditing:
    Principal=Everyone, Type=All, AppliesTo=This folder, subfolders and files
    Permissions: Delete, Delete subfolders and files (and optionally Write/Create)

TASK Audit.InstallAlerts:
  write alert handler → %LOCALAPPDATA%\CLI_AuditAlert\AuditAlert.ps1
  register Scheduled Task (TaskName from config):
    Trigger: Event Log → Security, EventID=4663
    XPath filter: NOT starts-with(ObjectName, any of Audit.AllowRoots[])
    Action: call AuditAlert.ps1 with EventRecordId
  (Toast/webhook/JSONL output driven by Audit.Notify)

TASK Audit.RemoveAlerts:
  unregister the Scheduled Task

TASK Audit.TestAlert:
  append synthetic JSON line to Audit.Notify.WriteJson

Operational Runbook (recommended flow)
Init:
  CONFIGURE_ENV_BASELINES()
  INSTALL_BASE_RUNTIMES()
  ENSURE_PIPX_AND_PNPM()

Bootstrap:
  INSTALL_PYTHON_CLIS_VIA_PIPX()
  INSTALL_NODE_CLIS_GLOBALLY()
  APPLY_CENTRALIZATION_ENVS()
  if MasterBin.Enable: MasterBin.Rebuild()
  Pin.Sync()            // optional: lock exact versions

Guard:
  Enforce.Once()        // link/quarantine existing caches in projects
  (optional) Watcher.Watch() in a dedicated window

Hygiene & Ops:
  Health.Check()        → health.json
  Update.Check()        → updates.json
  Scan.Report()         → misplaced.json + duplicates.json

Secrets:
  Secrets.Set()         // one-time per secret
  Secrets.ExportEnv()   // per session before running CLIs

Audit:
  ENABLE_OBJECT_ACCESS_AUDIT() + ENABLE_FOLDER_AUDIT()
  Audit.InstallAlerts() // optional real-time monitoring

InvokeBuild Task Map (aggregate)
task Bootstrap  := PipxInstall, NpmInstall, CentralizeApply, Pin.Sync
task Rebuild    := Bootstrap, Enforce.Once, Health.Check, Update.Check, Scan.Report, Audit.Setup?
task Verify     := prints versions + summarizes REPORTS_DIR
task Watch      := Watcher.Watch

Edge Cases & Policies
- Tools requiring project-local configs (intended by design):
    keep config under VCS; centralize only caches/state
- Symlinks unavailable:
    fall back to junctions; if cross-volume and junction fails, copy (warn)
- Name collisions (same CLI via npm and pipx):
    choose a single source; or resolve via MasterBin Priority/DenyList; or namespaced wrappers
- PATH plugin discovery (e.g., gh extensions):
    keep real bin dirs lower on PATH (MasterBin first, originals later), or add exceptions
- Security:
    prefer allow + monitor over blanket deny; use deny-delete only for immutable “golden” configs
- Reporting:
    all reports live under REPORTS_DIR; treat as CI artifacts

Minimal Config Example (trim to your needs)
{
  "ToolsRoot": "C:\\Tools",
  "PipxApps": ["invoke","aider-chat","ruff","black","isort","pylint","mypy","pyright","pytest","nox","pre-commit","uv","langgraph-cli"],
  "NpmGlobal": ["@google/generative-ai-cli","@anthropic-ai/claude-code","@google/jules","@specifyapp/cli","eslint","prettier"],
  "CopilotPkgs": ["github-copilot-cli","@githubnext/github-copilot-cli"],

  "Pins": {
    "pipx": {"ruff":"0.14.1","black":"25.9.0","isort":"7.0.0","pylint":"4.0.1","mypy":"1.18.2","pyright":"1.1.407","pytest":"8.4.2","pre-commit":"3.8.0"},
    "npm":  {"@google/generative-ai-cli":"0.11.3","@anthropic-ai/claude-code":"2.0.31","eslint":"9.39.0","prettier":"3.6.2"}
  },

  "MasterBin": {
    "Enable": false,
    "Path": "C:\\Tools\\bin",
    "Sources": ["C:\\Tools\\pipx\\bin","C:\\Tools\\node\\npm","C:\\Tools\\pnpm\\bin"],
    "Priority": ["pipx","npm","pnpm"],
    "DenyList": ["node","python","py","npm","pnpm"]
  },

  "WatchRoots": ["C:\\Users\\<YOU>\\Projects","D:\\Work"],
  "CentralCache": "C:\\Tools\\cache",

  "Scan": {
    "Roots": ["C:\\Users\\<YOU>\\Projects","D:\\Work"],
    "AllowCentral": ["C:\\Tools\\config","C:\\Tools\\cache","C:\\Tools\\data"],
    "Patterns": [".ruff_cache",".mypy_cache",".pytest_cache",".eslintcache",".prettier-cache","__pycache__", ".cache", "node_modules\\.cache"],
    "MinSizeKBForHash": 0
  },

  "Secrets": {
    "VaultPath": "%LOCALAPPDATA%\\CLI_Vault\\vault.json",
    "EnvMap": {"OPENAI_API_KEY":"openai","ANTHROPIC_API_KEY":"anthropic","GITHUB_TOKEN":"github"}
  },

  "Reports": { "Dir": "%LOCALAPPDATA%\\CLI_Reports" },

  "Audit": {
    "AllowRoots": ["C:\\Tools\\config","C:\\Tools\\cache","C:\\Tools\\data"],
    "Notify": { "Toast": false, "WriteJson": "C:\\Tools\\audit\\4663.jsonl", "WebhookUrl": "" },
    "TaskName": "CLI_4663_Alerts"
  }
}